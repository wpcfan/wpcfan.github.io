<!DOCTYPE html>
<html>

	
	    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
    <meta content="Angular 2 教程第七篇，动画框架、第三方对话框以及生命周期钩子" name="description">
  
  
    <meta name="keywords" content="web, javascript, angular2">
  
  <meta name="author" content="Peng">

  <title>
    
        Think Smarter, Code Smarter|Angular 2.x 从0到1（七）
    
  </title>
  <!-- favicon -->
  <link rel="shortcut icon" href="/static/img/favicon.ico">

  <!-- Third-party CSS -->
  <link href="/bower_components/normalize-css/normalize.min.css" rel="stylesheet">
  <link href="/bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/bower_components/animate.css/animate.min.css" rel="stylesheet">
  <link href="/bower_components/components-font-awesome/css/font-awesome.min.css" rel="stylesheet">
  <link href="/static/font-mfizz/font-mfizz.css" rel="stylesheet">
  <!-- <link href="/bower_components/toastr/toastr.min.css" rel="stylesheet"> -->
  <link href="/bower_components/jquery.gritter/css/jquery.gritter.css" rel="stylesheet">
  <link rel="stylesheet" href="/search/css/cb-search.css">

  <!-- Custom styles for this template -->
  <link href="/static/css/style.min.css" rel="stylesheet">
  <link href="/static/css/pygments.css" rel="stylesheet">

  <!-- Scripts -->
  <script src="/bower_components/jquery/dist/jquery.min.js"></script>
  <script src="/search/js/bootstrap3-typeahead.min.js"></script>

  <!-- cb-search -->
  <script src="/search/js/cb-search.js"></script>
  <script>
    $(function(){
        $("pre").css('display','block');
    });
  </script>
  <!-- Mainly scripts -->
  <script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
  <script src="/bower_components/metisMenu/dist/metisMenu.min.js"></script>
  <script src="/bower_components/jquery-slimscroll/jquery.slimscroll.min.js"></script>

  <!-- Peity -->
  <script src="/bower_components/peity/jquery.peity.min.js"></script>

  <script src="/bower_components/PACE/pace.min.js"></script>
  <script src="/bower_components/wow/dist/wow.min.js"></script>
  <!-- Custom and plugin javascript -->
  <script src="/static/js/inspinia.js"></script>

  <!-- Rickshaw -->
  <script src="/bower_components/rickshaw/vendor/d3.v3.js"></script>
  <script src="/bower_components/rickshaw/rickshaw.min.js"></script>


  <!-- jPages -->
  <script src="/static/js/jPages.js"></script>
  <script src="/static/js/js.js"></script>
  
  <script type="text/javascript">
        $(function(){
          /* initiate the plugin */
          $("div.pag-holder").jPages({
              containerID  : "pag-itemContainer",
              perPage      : 5,  /* num of items per page */
              startPage    : 1,
              startRange   : 1,
              midRange     : 3,
              endRange     : 1
          });
      });
  </script>
  <script src="//cdn.bootcss.com/highlight.js/9.9.0/highlight.min.js"></script>
<!-- GrowingIO -->


</head>

	


<body id="page-top" class="landing-page">

	
	    <div class="search-tool"
      style="position: fixed; top: 0px ; bottom: 0px; left: 0px; right:  0px; opacity: 0.95; background-color: #111111; z-index: 9999; display: none;">
    <input type="text" class="form-control search-content" id="search-content" style="position: fixed; top: 60px" placeholder="Search Blog">

    <div style="position: fixed; top: 16px; right: 16px; z-index: 9999;">
        <img src="/search/img/cb-close.png" id="close-btn"/>
    </div>
</div>

<div style="position: fixed; right: 16px; bottom: 20px; z-index: 9999;">
    <img src="/search/img/cb-search.png"  id="search-btn"  title="Double click Ctrl"/>
</div>

<div class="navbar-wrapper">
        <nav class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">
                <div class="navbar-header page-scroll">
                    <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="/">Think Smarter, Code Smarter</a>
                </div>
                <div id="navbar" class="navbar-collapse collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li><a class="page-scroll" href="/blog/"></a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/blog/">Blog</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/python/">Python</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/javascript/">JavaScript</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/html/">HTML</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/database/">Database</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/mac/">Mac</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/android/">Android</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/iOS/">iOS</a></li>
                        
                            
                            <li>
                            
                            <a class="page-scroll" href="/life/">Life</a></li>
                        
                    </ul>
                </div>
            </div>
        </nav>
</div>
<div id="inSlider" class="carousel carousel-fade" data-ride="carousel">
    <ol class="carousel-indicators">
        <li data-target="#inSlider" data-slide-to="0" class="active"></li>
        <li data-target="#inSlider" data-slide-to="1"></li>
    </ol>
    <div class="carousel-inner" role="listbox">
        <div class="item active">
            <div class="container">
                <div class="carousel-caption">
                </div>
                <div class="carousel-image wow zoomIn">
                    <!-- <img src="static/img/landing/laptop.png" alt="laptop"/> -->
                </div>
            </div>
            <!-- Set background for slide in css -->
            <div class="header-back one"></div>

        </div>
        <div class="item">
            <div class="container">
                <div class="carousel-caption blank">
                </div>
            </div>
            <!-- Set background for slide in css -->
            <div class="header-back two"></div>
        </div>
    </div>
    <a class="left carousel-control" href="#inSlider" role="button" data-slide="prev">
        <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
        <span class="sr-only">Previous</span>
    </a>
    <a class="right carousel-control" href="#inSlider" role="button" data-slide="next">
        <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
        <span class="sr-only">Next</span>
    </a>
</div>

	

    <div class="wrapper wrapper-content  animated fadeInRight article">
    <div class="row">
        <div class="col-lg-10 col-lg-offset-1">
            <div class="ibox">
                <div class="ibox-content">
                    <div class="pull-right">
                    	
                        	<button class="btn btn-white btn-xs" type="button">JavaScript</button>
                        
                    </div>
                    <div class="text-center article-title">
                    <span class="text-muted"><i class="fa fa-clock-o"></i> 7 Dec 2016</span>
                        <h1>
                            Angular 2.x 从0到1（七）
                        </h1>
                    </div>
                    	<ul id="markdown-toc">
  <li><a href="#第七章给组件带来活力" id="markdown-toc-第七章给组件带来活力">第七章：给组件带来活力</a>    <ul>
      <li><a href="#更炫的登陆页" id="markdown-toc-更炫的登陆页">更炫的登陆页</a>        <ul>
          <li><a href="#响应式的css框架" id="markdown-toc-响应式的css框架">响应式的CSS框架</a></li>
          <li><a href="#寻找免费的图片源" id="markdown-toc-寻找免费的图片源">寻找免费的图片源</a></li>
        </ul>
      </li>
      <li><a href="#自带动画技能的angular2" id="markdown-toc-自带动画技能的angular2">自带动画技能的Angular2</a></li>
      <li><a href="#完成遗失已久的注册功能" id="markdown-toc-完成遗失已久的注册功能">完成遗失已久的注册功能</a>        <ul>
          <li><a href="#restful-api的实验" id="markdown-toc-restful-api的实验">Restful API的实验</a></li>
        </ul>
      </li>
      <li><a href="#angular-2的组件生命周期" id="markdown-toc-angular-2的组件生命周期">Angular 2的组件生命周期</a></li>
    </ul>
  </li>
</ul>

<hr />

<h1 id="第七章给组件带来活力">第七章：给组件带来活力</h1>

<p>这节我们的主题是“专注酷炫一百年”；-）其实…没那么夸张了，但我们还是要在这一节了解MDL css框架、Angular2 内建的动画特性、更复杂的组件和概括一下Angular2的组件生命周期。</p>

<h2 id="更炫的登陆页">更炫的登陆页</h2>

<p>大家不知道有没有试用过bing（必应）搜索引擎（在Google无法访问的情况下，bing的英文搜索还是不错的选择），这个搜索引擎的主页很有特点：每日都会有一张非常好看的图作为背景。</p>

<p><img src="http://static.zybuluo.com/wpcfan/rpvxg5kcdy1gs6pka50wieda/image_1b36ghm4o179516kdikkbc14qp9.png" alt="bing搜索的首页有每日一图" /></p>

<p>我们想做的一个特效呢是类似地给登陆页增加一个背景，但更酷的一点是，我们的背景每隔3秒会自动替换一张。由于涉及到布局，我们先来熟悉一下CSS的框架设计。</p>

<h3 id="响应式的css框架">响应式的CSS框架</h3>

<p>目前主流的响应式css框架都有网格的概念，在我们现在使用的MDL（Material Design Lite）框架中叫做grid。在MDL中，一个页面在PC浏览器上的展现宽度有12个格子（cell），在平板上有8个格子，在手机上有4个格子。即一个grid的一行在PC上是12个cell，在平板上是8个cell，在手机上是4个cell。如果一行中的cell数目大于限制数目（比如在PC上超过12个），MDL会做折行处理。标识一个grid容器也很简单，在对应标签加上<code class="highlighter-rouge">class="mdl-grid"</code>即可。类似的每个cell需要在对应标签内加上<code class="highlighter-rouge">class="mdl-cell"</code>。如果要定制化grid的话，我们需要给class添加多个样式类名，比如如果希望grid内是没有间隔的，可以写成<code class="highlighter-rouge">class="mdl-grid mdl-grid--no-spacing"</code>；如果希望添加更多自己的定义，类似的可以写成<code class="highlighter-rouge">mdl-grid my-grid-style</code>，然后在css中定义这个<code class="highlighter-rouge">my-grid-style</code>即可。</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-grid"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--1-col"</span><span class="nt">&gt;</span>1<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--1-col"</span><span class="nt">&gt;</span>1<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--1-col"</span><span class="nt">&gt;</span>1<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--1-col"</span><span class="nt">&gt;</span>1<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--1-col"</span><span class="nt">&gt;</span>1<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--1-col"</span><span class="nt">&gt;</span>1<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--1-col"</span><span class="nt">&gt;</span>1<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--1-col"</span><span class="nt">&gt;</span>1<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--1-col"</span><span class="nt">&gt;</span>1<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--1-col"</span><span class="nt">&gt;</span>1<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--1-col"</span><span class="nt">&gt;</span>1<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--1-col"</span><span class="nt">&gt;</span>1<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-grid"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--4-col"</span><span class="nt">&gt;</span>4<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--4-col"</span><span class="nt">&gt;</span>4<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--4-col"</span><span class="nt">&gt;</span>4<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-grid"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--6-col"</span><span class="nt">&gt;</span>6<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--4-col"</span><span class="nt">&gt;</span>4<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--2-col"</span><span class="nt">&gt;</span>2<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-grid"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--6-col mdl-cell--8-col-tablet"</span><span class="nt">&gt;</span>6 (8 tablet)<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--4-col mdl-cell--6-col-tablet"</span><span class="nt">&gt;</span>4 (6 tablet)<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--2-col mdl-cell--4-col-phone"</span><span class="nt">&gt;</span>2 (4 phone)<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre>
</div>

<p><img src="http://static.zybuluo.com/wpcfan/fwq8nslpo6j6g4dwv534xhfy/image_1b36l1ajl1qqm1t091m89gbe1cr7m.png" alt="响应式布局在PC浏览器的展现" /></p>

<p>你可以尝试把浏览器的窗口缩小，让宽度变窄，调整到一定程度后你会发现，布局改变了，变成了下面的样子，这就是同样的代码在平板上的效果。你会发现原本的第一行折成了两行，因为在平板上8个cell是一行。你可以试试继续把浏览器的宽度变窄，看看在手机上的效果。</p>

<p><img src="http://static.zybuluo.com/wpcfan/d749paatwa3if5lagm9sbg86/image_1b36lq1ikh3vnfkadg8rpnrm13.png" alt="响应式布局在小窗口时的变化" /></p>

<p>下面我们看看怎么对Login页面做改造，首先在<code class="highlighter-rouge">form</code>外套一层<code class="highlighter-rouge">div</code>，并应用grid相关的css类，当然为了设置背景图，我们使用了一个angular属性ngStyle，这样让我们可以动态的改变背景图。grid里面我们仅有一个有实际内容的cell，就是form了，这个form在PC和平板上都占3个cell，在手机上占4个cell。但为了使这个form可以放在页面靠右的位置，我们添加了2个占位标签<code class="highlighter-rouge">mdl-layout-spacer</code>，标签的作用使将cell剩余的横向空间占满。</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;div</span>
  <span class="na">class=</span><span class="s">"mdl-grid mdl-grid--no-spacing login-container"</span>
  <span class="err">[</span><span class="na">ngStyle</span><span class="err">]="{'</span><span class="na">background-image</span><span class="err">'</span><span class="na">:</span> <span class="err">'</span><span class="na">url</span><span class="err">('</span> <span class="err">+</span> <span class="na">photo</span> <span class="err">+</span> <span class="err">')'}"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;mdl-layout-spacer</span>
    <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--8-col mdl-cell--4-col-tablet mdl-cell--hide-phone"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/mdl-layout-spacer&gt;</span>
  <span class="nt">&lt;form</span>
    <span class="na">class=</span><span class="s">"mdl-cell mdl-cell--3-col mdl-cell--3-col-tablet mdl-cell--4-col-phone login-form"</span>
    <span class="err">(</span><span class="na">ngSubmit</span><span class="err">)="</span><span class="na">onSubmit</span><span class="err">()"</span>
    <span class="nt">&gt;</span>
    <span class="c">&lt;!--...(这里省略掉其他控件的内容)--&gt;</span>
  <span class="nt">&lt;/form&gt;</span>
  <span class="nt">&lt;mdl-layout-spacer&gt;&lt;/mdl-layout-spacer&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre>
</div>

<p>在我们还没有找到可以动态配置的图片源之前，为了看看页面效果，我们可以先找一张图片放在<code class="highlighter-rouge">src\assets</code>目录下面，然后在LoginComponent中将其赋值给photo: <code class="highlighter-rouge">photo = '/assets/login_default_bg.jpg';</code>。接下来就看看现在的页面效果吧。</p>

<p><img src="http://static.zybuluo.com/wpcfan/du7mdyjtiszhuusvo8acicp4/image_1b37me9ik1eba1ruq98s1n041siq9.png" alt="在asset目录配置图片资源" /></p>

<h3 id="寻找免费的图片源">寻找免费的图片源</h3>

<p>当然我们可以找到一些免费的图片，然后存到本地来实现这个功能，但如果有一个海量的图片库，我们可以根据关键字搜索不同的图片不是更酷了吗？幸运的是Bing搜索是有API的，去 https://www.microsoft.com/cognitive-services/en-us/bing-image-search-api 点击<code class="highlighter-rouge">Get Started for free</code>后点选<code class="highlighter-rouge">Bing Image Search</code>申请获得一个API key即可。</p>

<p><img src="http://static.zybuluo.com/wpcfan/r4fnf9io4dky0a3gp9oso82i/image_1b36ncud0epmjsjsrjqds1tka9.png" alt="申请Bing Image API" /></p>

<p>申请完毕后可以在<code class="highlighter-rouge">My Account</code>中看到你的key，默认是隐藏的，点击<code class="highlighter-rouge">Show</code>链接即可看到了，点击Copy链接可以拷贝key到剪贴板。</p>

<p><img src="http://static.zybuluo.com/wpcfan/tv2fvnqqv12o1nnobd0ip64l/image_1b36npfqlhkq0l1fge1o8jon0m.png" alt="查找API Key" /></p>

<p>Bing Image Search API的Request Url是:<code class="highlighter-rouge">https://api.cognitive.microsoft.com/bing/v5.0/images/search</code>，后面可以跟随一系列参数，其中q是必选参数，指明搜索的关键字。</p>

<table>
  <thead>
    <tr>
      <th>参数</th>
      <th style="text-align: left">是否必选</th>
      <th style="text-align: center">类型</th>
      <th style="text-align: right">功能描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>q</td>
      <td style="text-align: left">是</td>
      <td style="text-align: center">string</td>
      <td style="text-align: right">搜索关键字</td>
    </tr>
    <tr>
      <td>count</td>
      <td style="text-align: left">否</td>
      <td style="text-align: center">number</td>
      <td style="text-align: right">返回的图片数量，实际返回值可能小于指定值</td>
    </tr>
    <tr>
      <td>offset</td>
      <td style="text-align: left">否</td>
      <td style="text-align: center">number</td>
      <td style="text-align: right">要跳过的结果数量</td>
    </tr>
    <tr>
      <td>mkt</td>
      <td style="text-align: left">否</td>
      <td style="text-align: center">string</td>
      <td style="text-align: right">从那个国家搜索，比如美国就是<code class="highlighter-rouge">en-US</code></td>
    </tr>
    <tr>
      <td>safeSearch</td>
      <td style="text-align: left">否</td>
      <td style="text-align: center">string</td>
      <td style="text-align: right">应用过滤器过滤掉不良成人内容</td>
    </tr>
  </tbody>
</table>

<p>知道了这些参数的意义后，我们可以在<code class="highlighter-rouge">login</code>目录下新建一个<code class="highlighter-rouge">BingImageService</code>：</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kr">import</span> <span class="p">{</span> <span class="nx">Injectable</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">Http</span><span class="p">,</span> <span class="nx">Headers</span><span class="p">,</span> <span class="nx">Response</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/http'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'rxjs/Rx'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">Image</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">'../domain/entities'</span><span class="p">;</span>

<span class="err">@</span><span class="nx">Injectable</span><span class="p">()</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">BingImageService</span> <span class="p">{</span>

  <span class="nl">imageUrl</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nx">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Headers</span><span class="p">({</span>
    <span class="s1">'Content-Type'</span><span class="p">:</span> <span class="s1">'application/json'</span><span class="p">,</span>
    <span class="c1">//把你获得API key在这里替换掉下面的enter-your-api-key-here</span>
    <span class="s1">'Ocp-Apim-Subscription-Key'</span><span class="p">:</span> <span class="s1">'enter-your-api-key-here'</span>
  <span class="p">});</span>

  <span class="nx">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">http</span><span class="err">:</span> <span class="nx">Http</span><span class="p">)</span> <span class="p">{</span>
    <span class="kr">const</span> <span class="nx">q</span> <span class="o">=</span> <span class="s1">'北极+墙纸'</span><span class="p">;</span>
    <span class="kr">const</span> <span class="nx">baseUrl</span><span class="err">:</span> <span class="nx">string</span> <span class="o">=</span> <span class="err">`</span><span class="nx">https</span><span class="err">:</span><span class="c1">//api.cognitive.microsoft.com/bing/v5.0/images/search`;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">imageUrl</span> <span class="o">=</span> <span class="nx">baseUrl</span> <span class="o">+</span> <span class="err">`</span><span class="p">?</span><span class="nx">q</span><span class="o">=</span><span class="nx">$</span><span class="p">{</span><span class="nx">q</span><span class="p">}</span><span class="o">&amp;</span><span class="nx">count</span><span class="o">=</span><span class="mi">5</span><span class="o">&amp;</span><span class="nx">mkt</span><span class="o">=</span><span class="nx">zh</span><span class="o">-</span><span class="nx">CN</span><span class="o">&amp;</span><span class="nx">imageType</span><span class="o">=</span><span class="nx">Photo</span><span class="o">&amp;</span><span class="nx">size</span><span class="o">=</span><span class="nx">Large</span><span class="err">`</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">getImageUrl</span><span class="p">():</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">Image</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">imageUrl</span><span class="p">,</span> <span class="p">{</span> <span class="na">headers</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">headers</span> <span class="p">})</span>
            <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="nx">value</span> <span class="nx">as</span> <span class="nx">Image</span><span class="p">[])</span>
            <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">handleError</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kr">private</span> <span class="nx">handleError</span><span class="p">(</span><span class="na">error</span><span class="p">:</span> <span class="nx">Response</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">Observable</span><span class="p">.</span><span class="k">throw</span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">json</span><span class="p">().</span><span class="nx">error</span> <span class="o">||</span> <span class="s1">'Server error'</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>
<p>然后在LoginComponent中即可调用这个服务，在得到返回的图片结果后我们就可以去替换掉默认本地图片的地址了。由于我们是得到一个图片地址的数组，所以我们还需要一个对这个数组中的每张图片做一个4秒的等待。而且我们还做了一个小处理 <code class="highlighter-rouge">i = (i + 1) % length;</code>，使得图片可以循环播放。</p>

<p>注意到我们让LoginComponent实现了<code class="highlighter-rouge">OnDestroy</code>接口，这是由于我们希望在页面销毁时也同时销毁观察者的订阅，而不是让它一直跑在后台。</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">//代码片段</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">LoginComponent</span> <span class="kr">implements</span> <span class="nx">OnDestroy</span> <span class="p">{</span>

  <span class="nx">username</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
  <span class="nx">password</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
  <span class="nl">auth</span><span class="p">:</span> <span class="nx">Auth</span><span class="p">;</span>
  <span class="nl">slides</span><span class="p">:</span> <span class="nx">Image</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="nx">photo</span> <span class="o">=</span> <span class="s1">'/assets/login_default_bg.jpg'</span><span class="p">;</span>
  <span class="nl">subscription</span><span class="p">:</span> <span class="nx">Subscription</span><span class="p">;</span>

  <span class="nx">constructor</span><span class="p">(</span>
    <span class="err">@</span><span class="nx">Inject</span><span class="p">(</span><span class="s1">'auth'</span><span class="p">)</span> <span class="kr">private</span> <span class="nx">authService</span><span class="p">,</span>
    <span class="err">@</span><span class="nx">Inject</span><span class="p">(</span><span class="s1">'bing'</span><span class="p">)</span> <span class="kr">private</span> <span class="nx">bingService</span><span class="p">,</span>
    <span class="kr">private</span> <span class="nx">router</span><span class="err">:</span> <span class="nx">Router</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">bingService</span><span class="p">.</span><span class="nx">getImageUrl</span><span class="p">()</span>
      <span class="p">.</span><span class="nx">subscribe</span><span class="p">((</span><span class="nx">images</span><span class="err">:</span> <span class="nx">Image</span><span class="p">[])</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">slides</span> <span class="o">=</span> <span class="p">[...</span><span class="nx">images</span><span class="p">];</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">rotateImages</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">slides</span><span class="p">);</span>
      <span class="p">});</span>
  <span class="p">}</span>
  <span class="p">...</span>
  <span class="nx">ngOnDestroy</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">subscription</span><span class="p">.</span><span class="nx">unsubscribe</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="nx">rotateImages</span><span class="p">(</span><span class="na">arr</span><span class="p">:</span> <span class="nx">Image</span><span class="p">[]){</span>
    <span class="kr">const</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">.</span><span class="nx">length</span>
    <span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">setInterval</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">i</span> <span class="o">=</span> <span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nx">length</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">photo</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">slides</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">contentUrl</span><span class="p">;</span>
    <span class="p">},</span> <span class="mi">4000</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>来喝杯咖啡，欣赏一下我们的成果吧！</p>

<p><img src="http://static.zybuluo.com/wpcfan/a1gsg1mcsyd4r96bypd55nvd/image_1b38vhduajb5bng1o3a1f73ua79.png" alt="每隔4秒换一张背景图的登录页面" /></p>

<p><img src="http://static.zybuluo.com/wpcfan/z3ok1yhh8lsuxg1aub49qifr/image_1b3912qu9bbduuokqe12031853m.png" alt="等待4秒后背景切换了" /></p>

<h2 id="自带动画技能的angular2">自带动画技能的Angular2</h2>

<p>Angular2的目标是一站式解决方案，当然会自带动画技能。动画会被定义在<code class="highlighter-rouge">@Component</code>描述性元数据中。在添加动画之前，先引入一些与动画有关的类库：</p>
<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kr">import</span> <span class="p">{</span>
  <span class="nx">Component</span><span class="p">,</span>
  <span class="nx">Inject</span><span class="p">,</span>
  <span class="nx">trigger</span><span class="p">,</span>
  <span class="nx">state</span><span class="p">,</span>
  <span class="nx">style</span><span class="p">,</span>
  <span class="nx">transition</span><span class="p">,</span>
  <span class="nx">animate</span><span class="p">,</span>
  <span class="nx">OnDestroy</span>
<span class="p">}</span> <span class="nx">from</span> <span class="s1">'@angular/core'</span><span class="p">;</span>
</code></pre>
</div>
<p>然后就可以在<code class="highlighter-rouge">@Component</code>元数据中去添加动画相关的元数据了，我们这里定义了一个叫<code class="highlighter-rouge">loginState</code>的动画触发器（trigger）。这个触发器会在<code class="highlighter-rouge">inactive</code>和<code class="highlighter-rouge">active</code>两个状态间转换。<code class="highlighter-rouge">scale(1.1)</code>是放缩比例，意味着我们对控件做了1.1倍的放大。这个动画的逻辑就是，当触发器处于<code class="highlighter-rouge">active</code>状态时，对应用这个触发器状态的控件做1.1倍放大处理。</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="err">@</span><span class="nx">Component</span><span class="p">({</span>
  <span class="na">selector</span><span class="p">:</span> <span class="s1">'app-login'</span><span class="p">,</span>
  <span class="na">templateUrl</span><span class="p">:</span> <span class="s1">'./login.component.html'</span><span class="p">,</span>
  <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="s1">'./login.component.css'</span><span class="p">],</span>
  <span class="na">animations</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">trigger</span><span class="p">(</span><span class="s1">'loginState'</span><span class="p">,</span> <span class="p">[</span>
      <span class="nx">state</span><span class="p">(</span><span class="s1">'inactive'</span><span class="p">,</span> <span class="nx">style</span><span class="p">({</span>
        <span class="na">transform</span><span class="p">:</span> <span class="s1">'scale(1)'</span>
      <span class="p">})),</span>
      <span class="nx">state</span><span class="p">(</span><span class="s1">'active'</span><span class="p">,</span>   <span class="nx">style</span><span class="p">({</span>
        <span class="na">transform</span><span class="p">:</span> <span class="s1">'scale(1.1)'</span>
      <span class="p">})),</span>
      <span class="nx">transition</span><span class="p">(</span><span class="s1">'inactive =&gt; active'</span><span class="p">,</span> <span class="nx">animate</span><span class="p">(</span><span class="s1">'100ms ease-in'</span><span class="p">)),</span>
      <span class="nx">transition</span><span class="p">(</span><span class="s1">'active =&gt; inactive'</span><span class="p">,</span> <span class="nx">animate</span><span class="p">(</span><span class="s1">'100ms ease-out'</span><span class="p">))</span>
    <span class="p">])</span>
  <span class="p">]</span>
<span class="p">})</span>
</code></pre>
</div>

<p>我们刚刚定义了一个动画，但它还没有被用到任何地方。要想使用它，可以在模板中用<code class="highlighter-rouge">[@triggerName]="xxx"</code>的形式来把它附加到一个或多个元素上。</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code>      <span class="nt">&lt;button</span>
        <span class="na">mdl-button</span> <span class="na">mdl-button-type=</span><span class="s">"raised"</span>
        <span class="na">mdl-colored=</span><span class="s">"primary"</span>
        <span class="na">mdl-ripple</span> <span class="na">type=</span><span class="s">"submit"</span>
        <span class="err">[@</span><span class="na">loginState</span><span class="err">]="</span><span class="na">loginBtnState</span><span class="err">"</span>
        <span class="err">(</span><span class="na">mouseenter</span><span class="err">)="</span><span class="na">toggleLoginState</span><span class="err">(</span><span class="na">true</span><span class="err">)"</span>
        <span class="err">(</span><span class="na">mouseleave</span><span class="err">)="</span><span class="na">toggleLoginState</span><span class="err">(</span><span class="na">false</span><span class="err">)"</span><span class="nt">&gt;</span>
        Login
      <span class="nt">&lt;/button&gt;</span>
</code></pre>
</div>

<p>这里我们对Login这个按钮应用了<code class="highlighter-rouge">loginState</code>触发器，并且绑定这个触发器的状态值到一个成员变量<code class="highlighter-rouge">loginBtnState</code>。而且我们定义了在鼠标进入按钮区域和离开按钮区域时应该通过一个函数<code class="highlighter-rouge">toggleLoginState</code>来改变<code class="highlighter-rouge">loginBtnState</code>的值。在<code class="highlighter-rouge">LoginComponent</code>中定义这个方法即可，我们要实现的这个功能非常简单，一行代码就搞定了：</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code>  <span class="nx">toggleLoginState</span><span class="p">(</span><span class="nx">state</span><span class="err">:</span> <span class="kr">boolean</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">loginBtnState</span> <span class="o">=</span> <span class="nx">state</span> <span class="p">?</span> <span class="s1">'active'</span> <span class="p">:</span> <span class="s1">'inactive'</span><span class="p">;</span>
  <span class="p">}</span>
</code></pre>
</div>
<p>试着将鼠标放在按钮上和离开按钮区域，看看按钮的变化的效果。</p>

<p><img src="http://static.zybuluo.com/wpcfan/0pbxveqx8yjt9xyb23m941te/image_1b396i9rc1jg9hbsgj5e44sns13.png" alt="鼠标离开和进入按钮区域时不同的按钮大小" /></p>

<h2 id="完成遗失已久的注册功能">完成遗失已久的注册功能</h2>

<p>我们自从完成了基本的多用户待办事项后就没有增加注册功能，现在来填补这个缺憾吧。我们打算在点击登录页的Register按钮时弹出一个注册用户的对话框。</p>

<p><img src="http://static.zybuluo.com/wpcfan/yfppqsaemxgviktatn6l3jyh/image_1b39tfmnni8hsnnila1c5cj701g.png" alt="我们要实现的注册对话框效果" /></p>

<p>如果实现一个对话框，利用我们已经引入的<code class="highlighter-rouge">angular2-mdl</code>库，需要几个步骤：</p>

<p>我们需要在<code class="highlighter-rouge">src\index.html</code>中增加一个“对话框插座”（<code class="highlighter-rouge">&lt;dialog-outlet&gt;&lt;/dialog-outlet&gt;</code>），就是在<code class="highlighter-rouge">&lt;app-root&gt;</code>下面添加即可。</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="cp">&lt;!doctype html&gt;</span>
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
...
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;app-root&gt;</span>Loading...<span class="nt">&lt;/app-root&gt;</span>
  <span class="nt">&lt;dialog-outlet&gt;&lt;/dialog-outlet&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
</div>

<p>建立dialog页面：<code class="highlighter-rouge">angular2-mdl</code>中有很多方便内建对话框和声明式方式，但我们这里介绍一种定制化程度比较高，也略显复杂的方式。打开一个命令行终端，输入 <code class="highlighter-rouge">ng g c login/register-dialog</code>。</p>

<p>对话框的模板比较简单，由一个用户名输入框、一个密码输入框、一个重复密码输入框、一个加载状态和一个注册按钮组成。其中我们希望按钮在表单验证正确后才可用，而且在处理注册过程中，按钮应该不可用。在处理注册过程中，应该有一个用户提示。</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="err">[</span><span class="na">formGroup</span><span class="err">]="</span><span class="na">form</span><span class="err">"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h3</span> <span class="na">class=</span><span class="s">"mdl-dialog__title"</span><span class="nt">&gt;</span>Register<span class="nt">&lt;/h3&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-dialog__content"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;mdl-textfield</span>
      <span class="err">#</span><span class="na">firstElement</span>
      <span class="na">type=</span><span class="s">"text"</span>
      <span class="na">label=</span><span class="s">"Username"</span>
      <span class="na">formControlName=</span><span class="s">"username"</span>
      <span class="na">floating-label</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/mdl-textfield&gt;</span>
    <span class="nt">&lt;br/&gt;</span>
    <span class="nt">&lt;mdl-textfield</span>
      <span class="na">type=</span><span class="s">"password"</span>
      <span class="na">label=</span><span class="s">"Password"</span>
      <span class="na">formControlName=</span><span class="s">"password"</span>
      <span class="na">floating-label</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/mdl-textfield&gt;</span>
    <span class="nt">&lt;br/&gt;</span>
    <span class="nt">&lt;mdl-textfield</span>
      <span class="na">type=</span><span class="s">"password"</span>
      <span class="na">label=</span><span class="s">"Repeat Password"</span>
      <span class="na">formControlName=</span><span class="s">"repeatPassword"</span>
      <span class="na">floating-label</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/mdl-textfield&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"status-bar"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;p</span> <span class="na">class=</span><span class="s">"mdl-color-text--primary"</span><span class="nt">&gt;&lt;/p&gt;</span>
    <span class="nt">&lt;mdl-spinner</span> <span class="err">[</span><span class="na">active</span><span class="err">]="</span><span class="na">processingRegister</span><span class="err">"</span><span class="nt">&gt;&lt;/mdl-spinner&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mdl-dialog__actions"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;button</span>
      <span class="na">type=</span><span class="s">"button"</span>
      <span class="na">mdl-button</span>
      <span class="err">(</span><span class="na">click</span><span class="err">)="</span><span class="na">register</span><span class="err">()"</span>
      <span class="err">[</span><span class="na">disabled</span><span class="err">]="!</span><span class="na">form</span><span class="err">.</span><span class="na">valid</span> <span class="err">||</span> <span class="na">processingRegister</span><span class="err">"</span>
      <span class="na">mdl-button-type=</span><span class="s">"raised"</span>
      <span class="na">mdl-colored=</span><span class="s">"primary"</span> <span class="na">mdl-ripple</span><span class="nt">&gt;</span>
      Register
    <span class="nt">&lt;/button&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre>
</div>

<p>那么对应的组件文件中，我们这次没有使用双向绑定，而是完全采取表单的方式进行。这里介绍几个新面孔：</p>

<ul>
  <li>FormBuilder：这个其实是一个工具类，用于快速构造一个表单。</li>
  <li>FormGroup：顾名思义是一组表单控件，一个表单可以有多个FormGroup，这个常常在比较复杂的表单中使用，用于更好的分类和控制。如果这一组中的任何一个控件验证失败，这个FormGroup的验证状态也是失败的。</li>
  <li>FormControl：跟踪表单控件的值和验证状态。</li>
</ul>

<p>Angular2 的FormControl中内置了常用的验证器（Validator），我们在这个例子中除此之外还给出了一个自定义的验证器 <code class="highlighter-rouge">passwordMatchValidator</code>，用于判断是否两次密码输入的是相同的。</p>

<p>此外呢我们还用到了一个新修饰符 <code class="highlighter-rouge">@HostListener</code> ，这个修饰符是指我们要监听宿主（这里是浏览器）的某些动作和变化。比如本例中，我们想要用户在按Esc键时关闭对话框，但这个动作并不局限在某个控件上，只要用户点击了Esc我们就关闭对话框，这时我们就得监听宿主的 <code class="highlighter-rouge">keydown.esc</code> 事件了。</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">//省略掉Import代码段和修饰符代码段</span>
<span class="p">...</span>
<span class="kr">export</span> <span class="kr">class</span> <span class="nx">RegisterDialogComponent</span><span class="p">{</span>
  <span class="err">@</span><span class="nx">ViewChild</span><span class="p">(</span><span class="s1">'firstElement'</span><span class="p">)</span> <span class="kr">private</span> <span class="nx">inputElement</span><span class="err">:</span> <span class="nx">MdlTextFieldComponent</span><span class="p">;</span>
  <span class="kr">public</span> <span class="nx">form</span><span class="err">:</span> <span class="nx">FormGroup</span><span class="p">;</span>
  <span class="kr">public</span> <span class="nx">processingRegister</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="kr">public</span> <span class="nx">statusMessage</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
  <span class="kr">private</span> <span class="nx">subscription</span><span class="err">:</span> <span class="nx">Subscription</span><span class="p">;</span>

  <span class="nx">constructor</span><span class="p">(</span>
    <span class="kr">private</span> <span class="nx">dialog</span><span class="err">:</span> <span class="nx">MdlDialogReference</span><span class="p">,</span>
    <span class="kr">private</span> <span class="nx">fb</span><span class="err">:</span> <span class="nx">FormBuilder</span><span class="p">,</span>
    <span class="kr">private</span> <span class="nx">router</span><span class="err">:</span> <span class="nx">Router</span><span class="p">,</span>
    <span class="err">@</span><span class="nx">Inject</span><span class="p">(</span><span class="s1">'auth'</span><span class="p">)</span> <span class="kr">private</span> <span class="nx">authService</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">form</span> <span class="o">=</span> <span class="nx">fb</span><span class="p">.</span><span class="nx">group</span><span class="p">({</span>
        <span class="s1">'username'</span><span class="p">:</span>  <span class="k">new</span> <span class="nx">FormControl</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span>  <span class="nx">Validators</span><span class="p">.</span><span class="nx">required</span><span class="p">),</span>
        <span class="s1">'passwords'</span><span class="p">:</span> <span class="nx">fb</span><span class="p">.</span><span class="nx">group</span><span class="p">({</span>
          <span class="s1">'password'</span><span class="p">:</span> <span class="k">new</span> <span class="nx">FormControl</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="nx">Validators</span><span class="p">.</span><span class="nx">required</span><span class="p">),</span>
          <span class="s1">'repeatPassword'</span><span class="p">:</span> <span class="k">new</span> <span class="nx">FormControl</span><span class="p">(</span><span class="s1">''</span><span class="p">,</span> <span class="nx">Validators</span><span class="p">.</span><span class="nx">required</span><span class="p">)</span>
        <span class="p">},{</span><span class="na">validator</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">passwordMatchValidator</span><span class="p">})</span>
      <span class="p">});</span>
      <span class="c1">// just if you want to be informed if the dialog is hidden</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">dialog</span><span class="p">.</span><span class="nx">onHide</span><span class="p">().</span><span class="nx">subscribe</span><span class="p">(</span> <span class="p">(</span><span class="nx">auth</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'login dialog hidden'</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">auth</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'authenticated user'</span><span class="p">,</span> <span class="nx">auth</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">});</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">dialog</span><span class="p">.</span><span class="nx">onVisible</span><span class="p">().</span><span class="nx">subscribe</span><span class="p">(</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">inputElement</span><span class="p">.</span><span class="nx">setFocus</span><span class="p">();</span>
      <span class="p">});</span>
  <span class="p">}</span>

  <span class="nx">passwordMatchValidator</span><span class="p">(</span><span class="na">group</span><span class="p">:</span> <span class="nx">FormGroup</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">statusMessage</span> <span class="o">=</span> <span class="s1">''</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">password</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'password'</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">confirm</span> <span class="o">=</span> <span class="nx">group</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'repeatPassword'</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>

    <span class="c1">// Don't kick in until user touches both fields</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">password</span><span class="p">.</span><span class="nx">pristine</span> <span class="o">||</span> <span class="nx">confirm</span><span class="p">.</span><span class="nx">pristine</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">password</span><span class="o">===</span><span class="nx">confirm</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">'mismatch'</span><span class="p">:</span> <span class="kc">true</span><span class="p">};</span>
  <span class="p">}</span>

  <span class="kr">public</span> <span class="nx">register</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">processingRegister</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">statusMessage</span> <span class="o">=</span> <span class="s1">'processing your registration ...'</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">subscription</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">authService</span>
      <span class="p">.</span><span class="nx">register</span><span class="p">(</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'username'</span><span class="p">).</span><span class="nx">value</span><span class="p">,</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">form</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'passwords'</span><span class="p">).</span><span class="nx">get</span><span class="p">(</span><span class="s1">'password'</span><span class="p">).</span><span class="nx">value</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span> <span class="nx">auth</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">processingRegister</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">statusMessage</span> <span class="o">=</span> <span class="s1">'you are registered and will be signed in ...'</span><span class="p">;</span>
        <span class="nx">setTimeout</span><span class="p">(</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">dialog</span><span class="p">.</span><span class="nx">hide</span><span class="p">(</span><span class="nx">auth</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">navigate</span><span class="p">([</span><span class="s1">'todo'</span><span class="p">]);</span>
        <span class="p">},</span> <span class="mi">500</span><span class="p">);</span>
    <span class="p">},</span> <span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">processingRegister</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">statusMessage</span> <span class="o">=</span> <span class="nx">err</span><span class="p">.</span><span class="nx">message</span><span class="p">;</span>
    <span class="p">});</span>
  <span class="p">}</span>

  <span class="err">@</span><span class="nx">HostListener</span><span class="p">(</span><span class="s1">'keydown.esc'</span><span class="p">)</span>
  <span class="kr">public</span> <span class="nx">onEsc</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">subscription</span> <span class="o">!==</span> <span class="kc">undefined</span><span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">subscription</span><span class="p">.</span><span class="nx">unsubscribe</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">dialog</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>这样做完后，打开浏览器却发现报错了，这是由于我们未引入 <code class="highlighter-rouge">ReactiveFormsModule</code> 造成的， <code class="highlighter-rouge">FormGroup</code> 是由 <code class="highlighter-rouge">ReactiveFormsModule</code> 提供的，因此要在 <code class="highlighter-rouge">src\app\login\login.module.ts</code> 中引入这个模块。</p>

<p><img src="http://static.zybuluo.com/wpcfan/4zesdanc1zzz9pv5684i6agp/image_1b3c404ni7qe1vv69uu6ubvhh9.png" alt="未引入ReactiveForms引起的报错" /></p>

<h3 id="restful-api的实验">Restful API的实验</h3>

<p>现在还需要完成服务器端的API。和以前类似的，我们需要先实验一下json-server的API，确定各参数可行的条件下再进行编码。由于现在我们需要进行GET以外的操作，所以如果有专业工具来辅助会比较方便，这里推荐一个Chrome App：Postman，可以自行科学上网后在Chrome商店搜索安装。安装后点左上角的应用即可看到Postman了</p>

<p><img src="http://static.zybuluo.com/wpcfan/cj4w92jxeoox33sn82xbjf4g/image_1b39uniimjrnv31kr7ajvei1t.png" alt="Chrome应用：Postman" /></p>

<p>点击Postman，输入<code class="highlighter-rouge">http://localhost:3000/users</code>可以看到返回的json数据了</p>

<p><img src="http://static.zybuluo.com/wpcfan/6m32j6pmfzyx4uv52mhnjrl0/image_1b39v6ibl4peqcgmhckc4ka2a.png" alt="PostMan的功能区介绍" /></p>

<p>我们来试验一下新增一个用户，但这个时候我们已经给User的id定义成数字类型了，实在不想改成UUID了，怎么办呢？幸运的是json-server其实是很聪明的，如果在POST时你不给它传入id字段，它会认为这个id是自增长的。在Postman中将HTTP方法设成POST，在Headers中写上 <code class="highlighter-rouge">Content-Type</code> 和 <code class="highlighter-rouge">application/json</code>。然后在Body中选择 <code class="highlighter-rouge">raw</code> ，并写入</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="p">{</span>
	<span class="s2">"username"</span><span class="err">:</span> <span class="s2">"testUser"</span><span class="p">,</span>
	<span class="s2">"password"</span><span class="err">:</span> <span class="s2">"testPassword"</span>
<span class="p">}</span>
</code></pre>
</div>

<p>点击Send后可以看到，新的id自动被写入了，这简直太方便了，也符合一般后端开发的套路。</p>

<p><img src="http://static.zybuluo.com/wpcfan/qwga78sqyohp5syyemdjsva5/image_1b3a2in1k145g15rej8icr51i4p2n.png" alt="用Postman测试自增长ID" /></p>

<p>知道这点后，我们着手写对应方法就很简单了，首先在 <code class="highlighter-rouge">UserService</code> 中添加addUser方法。</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code>  <span class="nx">addUser</span><span class="p">(</span><span class="nx">user</span><span class="err">:</span> <span class="nx">User</span><span class="p">)</span><span class="err">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">User</span><span class="o">&gt;</span><span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">http</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">api_url</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">user</span><span class="p">),</span> <span class="p">{</span><span class="na">headers</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">headers</span><span class="p">})</span>
            <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">()</span> <span class="nx">as</span> <span class="nx">User</span><span class="p">)</span>
            <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">handleError</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre>
</div>

<p>在AuthService中添加一个register方法，正如我们刚刚实验的那样，我们只需构造一个没有id的User对象即可。当然我们要检查一下用户名是否存在，如果不存在的话才可以注册新用户。这里又碰到一个新的Rx方法 <code class="highlighter-rouge">switchMap</code>，是用来对原来流中的对象做变换后，发射变换后的流。用一个图示来表示我们下面代码的逻辑是这样的</p>

<div class="highlighter-rouge"><pre class="highlight"><code>                                  null               null
                                   /                 /
应用filter前：User=====User=====User=====...=====User======...
应用filter后：==================User=====...=====User======...
(把user===null的滤出来)          |                |
应用switchMap后：              Auth======...======Auth=====... 

</code></pre>
</div>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code>  <span class="nx">register</span><span class="p">(</span><span class="nx">username</span><span class="err">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">password</span><span class="err">:</span> <span class="nx">string</span><span class="p">)</span><span class="err">:</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">Auth</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">toAddUser</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">username</span><span class="p">:</span> <span class="nx">username</span><span class="p">,</span>
      <span class="na">password</span><span class="p">:</span> <span class="nx">password</span>
    <span class="p">};</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">userService</span>
            <span class="p">.</span><span class="nx">findUser</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">user</span> <span class="o">=&gt;</span> <span class="nx">user</span> <span class="o">===</span> <span class="kc">null</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">switchMap</span><span class="p">(</span><span class="nx">user</span> <span class="o">=&gt;</span> <span class="p">{</span>
              <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">userService</span><span class="p">.</span><span class="nx">addUser</span><span class="p">(</span><span class="nx">toAddUser</span><span class="p">).</span><span class="nx">map</span><span class="p">(</span><span class="nx">u</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">auth</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span>
                  <span class="p">{},</span>
                  <span class="p">{</span> <span class="na">user</span><span class="p">:</span> <span class="nx">u</span><span class="p">,</span> <span class="na">hasError</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">errMsg</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span> <span class="na">redirectUrl</span><span class="p">:</span> <span class="kc">null</span><span class="p">}</span>
                <span class="p">);</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">subject</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">auth</span><span class="p">);</span>
                <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">auth</span><span class="p">;</span>
              <span class="p">});</span>
            <span class="p">});</span>
  <span class="p">}</span>
</code></pre>
</div>

<p>打开浏览器，检查所有功能是否完整可用，正常情况下点Register你可以看到下面的界面，试着注册一个新用户，开始管理你的待办事项吧。</p>

<p><img src="http://static.zybuluo.com/wpcfan/sarm4ukcxyd8wrnqssdy6xr2/image_1b3c5t3g11edk83n1c1olrci739.png" alt="完成注册功能的页面" /></p>

<h2 id="angular-2的组件生命周期">Angular 2的组件生命周期</h2>

<p><img src="http://static.zybuluo.com/wpcfan/jqvbexkvo0ubcu8ozhq7sjd5/image_1b3c6vnk21sj13831cec16n0gsnm.png" alt="angular 2 的组件生命周期函数" /></p>

<p>每个组件都有一个被Angular管理的生命周期：Angular创建、渲染控件；创建、渲染子控件；当数据绑定属性改变时做检查；在把控件移除DOM之前销毁控件等等。</p>

<p>Angular提供生命周期的“钩子”（Hook）以便于开发者可以得到这些关键过程的数据以及在这些过程中做出响应的能力。</p>

<p>指令也有类似的生命周期“钩子”函数，除了一些组件特有的函数外。</p>

<p>下面这段代码展现了如何利用 <code class="highlighter-rouge">ngOnInit</code> 这个钩子函数</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kr">export</span> <span class="kr">class</span> <span class="nx">PeekABoo</span> <span class="kr">implements</span> <span class="nx">OnInit</span> <span class="p">{</span>
  <span class="nx">constructor</span><span class="p">(</span><span class="kr">private</span> <span class="nx">logger</span><span class="err">:</span> <span class="nx">LoggerService</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>

  <span class="c1">// implement OnInit's `ngOnInit` method</span>
  <span class="nx">ngOnInit</span><span class="p">()</span> <span class="p">{</span> <span class="k">this</span><span class="p">.</span><span class="nx">logIt</span><span class="p">(</span><span class="err">`</span><span class="nx">OnInit</span><span class="err">`</span><span class="p">);</span> <span class="p">}</span>

  <span class="nx">logIt</span><span class="p">(</span><span class="nx">msg</span><span class="err">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`#</span><span class="nx">$</span><span class="p">{</span><span class="nx">nextId</span><span class="o">++</span><span class="p">}</span> <span class="nx">$</span><span class="p">{</span><span class="nx">msg</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>钩子函数的接口 （比如上面例子中的 <code class="highlighter-rouge">OnInit</code> ） 从纯技术的角度来说不是必须的，这是由于Javascript本身没有接口这个概念，而Typescript最终是转换成Javascript的。</p>

<p>Angular其实是通过检查指令或组件的类中是否定义了相关方法来进行的，比如上面例子中即使不实现 <code class="highlighter-rouge">OnInit</code> 接口，只要定义了 <code class="highlighter-rouge">ngOnInit()</code> 方法，Angular就会在对应的生命周期调用这个方法。但是还是推荐大家使用接口，因为强类型会给我们带来其他好处。</p>

<table>
  <thead>
    <tr>
      <th>函数</th>
      <th>应用范围</th>
      <th>目的和触发时机</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ngOnChanges</td>
      <td>组件和指令</td>
      <td>在ngInit之前触发，当Angular设置数据绑定属性或输入性属性时会得到一个包含当前和之前属性值的对象（SimpleChanges）</td>
    </tr>
    <tr>
      <td>ngOnInit</td>
      <td>组件和指令</td>
      <td>只调用一次，在设置完输入性属性后，通过这个函数初始化组件或指令</td>
    </tr>
    <tr>
      <td>ngDoCheck</td>
      <td>组件和指令</td>
      <td>在ngInit之后，每次检测到变化时触发，可以在此检查一些angular自身无法检查的变化</td>
    </tr>
    <tr>
      <td>ngAfterContentInit</td>
      <td>组件</td>
      <td>在ngDoCheck后触发，只调用一次，把要装载到组件视图的内容初始化后</td>
    </tr>
    <tr>
      <td>ngAfterContentChecked</td>
      <td>组件</td>
      <td>ngAfterContentInit之后每次ngDoCheck都会在之后触发ngAfterContentChecked，对要装载到组件视图的内容进行检查后</td>
    </tr>
    <tr>
      <td>ngAfterViewInit</td>
      <td>组件</td>
      <td>在第一个ngAfterContentInit被调用后触发，只调用一次，在angular初始化视图后响应</td>
    </tr>
    <tr>
      <td>ngAfterViewChecked</td>
      <td>组件</td>
      <td>在ngAfterViewInit后及每个ngAfterContentChecked后触发</td>
    </tr>
    <tr>
      <td>ngOnDestroy</td>
      <td>组件和指令</td>
      <td>在组件或指令被销毁前，清理环境，可以在此处取消Observable的订阅</td>
    </tr>
  </tbody>
</table>

<p>本节代码：https://github.com/wpcfan/awesome-tutorials/tree/chap07/angular2/ng2-tut</p>


                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                                <h5 style="display: inline;">Tags:</h5>
                                
                                    <button class="btn btn-white btn-xs" type="button">blog</button>
                                
                                    <button class="btn btn-white btn-xs" type="button">javascript</button>
                                
                                    <button class="btn btn-white btn-xs" type="button">angular2</button>
                                
                        </div>
                        <div class="col-md-6">
                            <div class="small text-right">
                                <h5>Stats:</h5>
                                <div> 
                                
                                    <i class="fa fa-comments-o"> </i> <span id = "url::/javascript/2016/12/07/angular-2.0-%E4%BB%8E0%E5%88%B01-%E4%B8%83.html" class = "cy_cmt_count" ></span> comments
                                
                                
                                </div>
                            </div>
                        </div>
                    </div>
                    <br>
                    <div class="row">
                        <div class="col-lg-12">
                            <!-- donate -->
                            
                                <div class="text-center">
<button class="btn btn-warning  dim btn-large-dim btn-outline" type="button" data-toggle="modal" data-target="#myModal2"><i class="fa fa-smile-o"></i></button>
</div>
<div class="modal inmodal" id="myModal2" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated flipInY">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">Donate Me</h4>
                <small class="font-bold">If you like this article and want to help me, please give me little fee.</small><br>
                <small class="font-bold">Thanks for your support!</small>
            </div>
            <div class="modal-body text-center">
                <img src="/static/img/pay/w1.jpeg" width="250">
                &emsp;
                <img src="/static/img/pay/w5.jpeg" width="250">
            </div>
        </div>
    </div>
</div>

                            
                            <br>
                            <!-- share -->
                            
                                <h2>Share:</h2>

<div class="bshare-custom">
	<a title="分享到微信" class="bshare-weixin"></a>
	<a title="分享到QQ空间" class="bshare-qzone"></a>
	<a title="分享到新浪微博" class="bshare-sinaminiblog"></a>
	<a title="更多平台" class="bshare-more bshare-more-icon more-style-addthis"></a>
</div>
<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/buttonLite.js#style=-1&amp;uuid=59fd3d05-03d3-43ad-9650-ef46f9487bb8&amp;pophcol=1&amp;lang=zh"></script>
<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/bshareC0.js"></script>
                            
                            <br>
                            <!-- comment -->
                            
<h2>Comments:</h2>
<div id="SOHUCS"></div>
<script charset="utf-8" type="text/javascript" src="http://changyan.sohu.com/upload/changyan.js" ></script>
<script type="text/javascript">
    window.changyan.api.config({
        appid: 'cysKvjNmC',
        conf: '14195e6733a549bb2f800fb931489c56'
    });
</script>




                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

</div>


	
	    <script src="/static/js/scroll.js"></script>

<!-- Baidu analytics -->

  <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?fc44e98b7062976fd7982188c4179bb8";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
  </script>


<!-- Google analytics -->





  <script id="cy_cmt_num" src="http://changyan.sohu.com/upload/plugins/plugins.list.count.js?clientId=cysfY7ULn"></script>



	

</body>
</html>